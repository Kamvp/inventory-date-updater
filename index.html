<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Zoro Tools Inventory Date Updater (Preview → Download)</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root { --ink:#0f172a; --sub:#334155; --chip:#e2e8f0; --bg:#f8fafc; --card:#ffffff; --brand:#0ea5e9; }
  html,body { height:100%; margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--ink); }
  .wrap { max-width:960px; margin:32px auto; padding:0 16px; }
  .card { background:var(--card); border-radius:16px; padding:24px; box-shadow:0 10px 30px rgba(2,6,23,.08); }
  h1 { font-size:1.3rem; margin:0 0 10px; }
  p  { color:var(--sub); margin:0 0 14px; }
  .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
  input[type=file] { padding:10px; border:1px solid #cbd5e1; border-radius:12px; background:#f1f5f9; }
  button { padding:10px 16px; border:0; border-radius:12px; cursor:pointer; background:var(--brand); color:#fff; font-weight:600; }
  button.secondary{ background:#0f766e; }
  button[disabled]{ opacity:.5; cursor:not-allowed; }
  .badge{ display:inline-block; padding:4px 8px; border-radius:999px; background:var(--chip); color:var(--sub); font-size:.8rem; }
  .muted{ color:var(--sub); font-size:.9rem; }
  .log { margin-top:12px; font-family:ui-monospace,Menlo,Consolas,monospace; background:#0b1020; color:#cbd5e1; padding:12px; border-radius:12px; white-space:pre-wrap; font-size:.85rem; display:none; }
  table { border-collapse:collapse; width:100%; margin-top:10px; }
  th,td{ border:1px solid #e5e7eb; padding:6px 8px; font-size:.9rem; }
  th{ background:#f1f5f9; text-align:left; }
  .divider{ height:1px; background:#e5e7eb; margin:14px 0; }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Zoro Tools Inventory Date Updater — Preview, then Download</h1>
    <p>Automatically updates inventory dates and renames output as:<br>
    <b>ZoroToolsInventoryUpload YYYY.MM.DD HH.mm am/pm.xlsx</b></p>

    <div class="row" style="margin-top:8px">
      <input id="file" type="file" accept=".xlsx" />
      <button id="preview" disabled>Preview updates</button>
      <span id="status" class="badge">Waiting for file</span>
    </div>

    <div id="summary" class="muted" style="margin-top:10px;"></div>
    <div id="previewArea" style="margin-top:12px; display:none;"></div>

    <div class="row" style="margin-top:10px">
      <button id="download" class="secondary" disabled>Download Updated .xlsx</button>
      <span id="outname" class="badge" title="Proposed download name" style="display:none;"></span>
    </div>

    <div id="log" class="log"></div>
  </div>
</div>

<script>
(function(){
  const TARGET_HEADERS = {
    "inventory reference #": ["inventory reference #","inventory ref #","inventory reference number"],
    "available to ship date": ["available to ship date","avail to ship date","ship available date"],
    "reporting location number": ["reporting location number","reporting location #","reporting location"]
  };

  const byId = x => document.getElementById(x);
  const fileInput  = byId('file');
  const previewBtn = byId('preview');
  const downloadBtn= byId('download');
  const statusEl   = byId('status');
  const summaryEl  = byId('summary');
  const previewArea= byId('previewArea');
  const outnameEl  = byId('outname');
  const logEl      = byId('log');

  const pad = n => String(n).padStart(2,'0');
  function cellDateYYYYMMDD(){
    const d = new Date();
    return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}`;
  }
  function dateDots(){
    const d = new Date();
    return `${d.getFullYear()}.${pad(d.getMonth()+1)}.${pad(d.getDate())}`;
  }
  function time24hAmPm(){
    const d = new Date();
    let h = d.getHours();
    const m = pad(d.getMinutes());
    const ampm = h >= 12 ? 'pm' : 'am';
    return `${pad(h)}.${m} ${ampm}`;
  }

  function normalize(s){ return String(s||"").trim().toLowerCase().replace(/\s+/g," "); }
  function findHeaderIndexes(headerRow){
    const map = {};
    const NR = headerRow.map(h => normalize(h));
    for (const canonical in TARGET_HEADERS){
      const vars = TARGET_HEADERS[canonical].map(normalize);
      let found = -1;
      for (const v of vars){
        const i = NR.indexOf(v);
        if (i !== -1){ found = i; break; }
      }
      if (found !== -1) map[canonical] = found;
    }
    return map;
  }

  let arrayBuffer=null, wbModified=null;

  fileInput.addEventListener('change', async (e)=>{
    const f = e.target.files?.[0];
    if(!f){ previewBtn.disabled=true; downloadBtn.disabled=true; statusEl.textContent="Waiting for file"; return; }
    arrayBuffer = await f.arrayBuffer();
    statusEl.textContent=`Loaded: ${f.name}`;
    summaryEl.textContent="";
    previewArea.style.display="none";
    outnameEl.style.display="none";
    wbModified=null;
    previewBtn.disabled=false;
    downloadBtn.disabled=true;
  });

  previewBtn.addEventListener('click', ()=>{
    if(!arrayBuffer) return;

    const baseName = "ZoroToolsInventoryUpload"; // fixed root name
    const finalName = `${baseName} ${dateDots()} ${time24hAmPm()}.xlsx`;
    outnameEl.textContent = finalName;
    outnameEl.style.display="inline-block";

    const wb = XLSX.read(arrayBuffer,{type:"array"});
    const stamp = cellDateYYYYMMDD();
    let totalRows=0, sheetsTouched=0, colsHit=new Set();

    wb.SheetNames.forEach(name=>{
      const ws=wb.Sheets[name];
      const A=XLSX.utils.sheet_to_json(ws,{header:1,defval:""});
      if(!A.length) return;
      const idx=findHeaderIndexes(A[0]);
      const cols=Object.values(idx);
      if(!cols.length) return;
      for(const k in idx){colsHit.add(k);}
      for(let r=1;r<A.length;r++){
        for(const c of cols){A[r][c]=stamp;}
        totalRows++;
      }
      const newWS=XLSX.utils.aoa_to_sheet(A);
      for(let r=1;r<A.length;r++){
        for(const c of cols){
          const addr=XLSX.utils.encode_cell({r,c});
          if(newWS[addr]) newWS[addr].t='s';
        }
      }
      wb.Sheets[name]=newWS;
      sheetsTouched++;
    });

    wbModified=wb;
    summaryEl.innerHTML=`Updated <b>${totalRows.toLocaleString()}</b> rows across <b>${sheetsTouched}</b> sheets.<br>Proposed name: <span class="badge">${finalName}</span>`;
    statusEl.textContent="Preview ready";
    downloadBtn.disabled=false;

    // preview first 12 rows
    const ws=wb.Sheets[wb.SheetNames[0]];
    const A=XLSX.utils.sheet_to_json(ws,{header:1,defval:""});
    const max=Math.min(A.length,13);
    let html=`<div class="divider"></div><div class="muted">Preview: <b>${wb.SheetNames[0]}</b> — first ${max-1} row(s)</div>`;
    if(A.length){
      html+=`<table><thead><tr>${A[0].map(h=>`<th>${h}</th>`).join("")}</tr></thead><tbody>${A.slice(1,max).map(r=>`<tr>${A[0].map((_,i)=>`<td>${r[i]??""}</td>`).join("")}</tr>`).join("")}</tbody></table>`;
    } else { html+=`<div class="muted">Sheet empty.</div>`; }
    previewArea.innerHTML=html;
    previewArea.style.display="block";
  });

  downloadBtn.addEventListener('click',()=>{
    if(!wbModified){alert("Preview first.");return;}
    const name=`ZoroToolsInventoryUpload ${dateDots()} ${time24hAmPm()}.xlsx`;
    XLSX.writeFile(wbModified,name);
  });
})();
</script>
</body>
</html>
