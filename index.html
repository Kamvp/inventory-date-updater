<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Zoro Tools Inventory Date Updater (Preview → Download)</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root { --ink:#0f172a; --sub:#334155; --chip:#e2e8f0; --bg:#f8fafc; --card:#ffffff; --brand:#0ea5e9; }
  html,body { height:100%; margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--ink); }
  .wrap { max-width:960px; margin:32px auto; padding:0 16px; }
  .card { background:var(--card); border-radius:16px; padding:24px; box-shadow:0 10px 30px rgba(2,6,23,.08); }
  h1 { font-size:1.3rem; margin:0 0 10px; }
  p  { color:var(--sub); margin:0 0 14px; }
  .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
  input[type=file] { padding:10px; border:1px solid #cbd5e1; border-radius:12px; background:#f1f5f9; }
  button { padding:10px 16px; border:0; border-radius:12px; cursor:pointer; background:var(--brand); color:#fff; font-weight:600; }
  button.secondary{ background:#0f766e; }
  button[disabled]{ opacity:.5; cursor:not-allowed; }
  .badge{ display:inline-block; padding:4px 8px; border-radius:999px; background:var(--chip); color:#334155; font-size:.8rem; }
  .muted{ color:#334155; font-size:.9rem; }
  .divider{ height:1px; background:#e5e7eb; margin:14px 0; }
  table { border-collapse:collapse; width:100%; margin-top:10px; }
  th,td{ border:1px solid #e5e7eb; padding:6px 8px; font-size:.9rem; }
  th{ background:#f1f5f9; text-align:left; }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Zoro Tools Inventory Date Updater — Preview, then Download</h1>
    <p>Updates only <span class="badge">INVENTORY REFERENCE #</span> and <span class="badge">AVAILABLE TO SHIP DATE</span> (all sheets) to today’s local date in <b>YYYYMMDD</b>. No other columns are changed.</p>

    <div class="row" style="margin-top:8px">
      <input id="file" type="file" accept=".xlsx" />
      <button id="preview" disabled>Preview updates</button>
      <span id="status" class="badge">Waiting for file</span>
    </div>

    <div id="summary" class="muted" style="margin-top:10px;"></div>
    <div id="previewArea" style="margin-top:12px; display:none;"></div>

    <div class="row" style="margin-top:10px">
      <button id="download" class="secondary" disabled>Download Updated .xlsx</button>
      <span id="outname" class="badge" title="Proposed download name" style="display:none;"></span>
    </div>
  </div>
</div>

<script>
(function(){
  // ---- Only these two columns will be updated (case-insensitive) ----
  const TARGET_HEADERS = {
    "inventory reference #": ["inventory reference #","inventory ref #","inventory reference number"],
    "available to ship date": ["available to ship date","avail to ship date","available-to-ship date","ship available date"]
  };
  // SAFETY: we intentionally DO NOT list "reporting location number" here, so it stays untouched.

  // ---- DOM helpers ----
  const $ = id => document.getElementById(id);
  const fileInput=$('file'), previewBtn=$('preview'), downloadBtn=$('download');
  const statusEl=$('status'), summaryEl=$('summary'), previewArea=$('previewArea'), outnameEl=$('outname');

  const pad=n=>String(n).padStart(2,'0');
  function cellDateYYYYMMDD(){ const d=new Date(); return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}`; }
  function dateDots(){ const d=new Date(); return `${d.getFullYear()}.${pad(d.getMonth()+1)}.${pad(d.getDate())}`; }
  function time24hAmPm(){ const d=new Date(); return `${pad(d.getHours())}.${pad(d.getMinutes())} ${d.getHours()>=12?'pm':'am'}`; }

  function normalize(s){ return String(s||"").trim().toLowerCase().replace(/\s+/g,' '); }
  function findHeaderIndexes(headerRow){
    const map={}, norm = headerRow.map(h=>normalize(h));
    for (const canonical in TARGET_HEADERS){
      const variants = TARGET_HEADERS[canonical].map(normalize);
      let found=-1;
      for (const v of variants){ const i=norm.indexOf(v); if(i!==-1){ found=i; break; } }
      if(found!==-1) map[canonical]=found;
    }
    return map;
  }

  // ---- state ----
  let arrayBuffer=null, wbModified=null;

  fileInput.addEventListener('change', async (e)=>{
    const f=e.target.files?.[0];
    if(!f){ previewBtn.disabled=true; downloadBtn.disabled=true; statusEl.textContent='Waiting for file'; return; }
    arrayBuffer=await f.arrayBuffer();
    statusEl.textContent=`Loaded: ${f.name}`;
    wbModified=null; previewBtn.disabled=false; downloadBtn.disabled=true;
    previewArea.style.display='none'; outnameEl.style.display='none'; summaryEl.textContent='';
  });

  // ---- Preview (apply updates in-memory + show first 12 rows of first sheet) ----
  previewBtn.addEventListener('click', ()=>{
    if(!arrayBuffer) return;

    const proposedName = `ZoroToolsInventoryUpload ${dateDots()} ${time24hAmPm()}.xlsx`;
    outnameEl.textContent = proposedName;
    outnameEl.style.display='inline-block';

    const stamp = cellDateYYYYMMDD();
    const wb = XLSX.read(arrayBuffer,{type:'array'});
    let touched=0, rows=0, colsHit=new Set();

    wb.SheetNames.forEach(name=>{
      const ws=wb.Sheets[name];
      const A=XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
      if(!A.length) return;

      const idxMap = findHeaderIndexes(A[0]);
      const cols = Object.values(idxMap);
      if(!cols.length) return;

      for (const k in idxMap) colsHit.add(k);

      for (let r=1;r<A.length;r++){
        for (const c of cols) A[r][c]=stamp; // write only to the two target columns
        rows++;
      }

      const newWS = XLSX.utils.aoa_to_sheet(A);
      for (let r=1;r<A.length;r++){
        for (const c of cols){
          const addr=XLSX.utils.encode_cell({r,c});
          if(newWS[addr]) newWS[addr].t='s';
        }
      }
      wb.Sheets[name]=newWS; touched++;
    });

    wbModified = wb;
    statusEl.textContent='Preview ready';

    summaryEl.innerHTML = `Updated <b>${rows.toLocaleString()}</b> rows across <b>${touched}</b> sheet(s). `
      + `Columns hit: <span class="badge">${[...colsHit].join(', ') || 'none found'}</span><br>`
      + `Proposed name: <span class="badge">${proposedName}</span>`;

    // preview first sheet (first 12 rows)
    const first = wb.SheetNames[0];
    const ws0 = wb.Sheets[first];
    const A0 = XLSX.utils.sheet_to_json(ws0,{header:1,defval:''});
    const max = Math.min(A0.length,13);
    let html = `<div class="divider"></div><div class="muted">Preview: <b>${first}</b> — first ${Math.max(0,max-1)} row(s)</div>`;
    if(A0.length){
      const head=A0[0];
      html += `<table><thead><tr>${head.map(h=>`<th>${String(h||'')}</th>`).join('')}</tr></thead><tbody>${
        A0.slice(1,max).map(row=>`<tr>${head.map((_,i)=>`<td>${String((row||[])[i]??'')}</td>`).join('')}</tr>`).join('')
      }</tbody></table>`;
    } else html += `<div class="muted">Sheet is empty.</div>`;
    previewArea.innerHTML=html; previewArea.style.display='block';

    downloadBtn.disabled=false;
  });

  // ---- Download (recompute name at click time so timestamp is current) ----
  downloadBtn.addEventListener('click', ()=>{
    if(!wbModified){ alert('Please click Preview first.'); return; }
    const finalName = `ZoroToolsInventoryUpload ${dateDots()} ${time24hAmPm()}.xlsx`;
    XLSX.writeFile(wbModified, finalName);
  });
})();
</script>
</body>
</html>
