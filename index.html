<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Inventory Date Updater (Preview → Download)</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root { --ink:#0f172a; --sub:#334155; --chip:#e2e8f0; --bg:#f8fafc; --card:#ffffff; --brand:#0ea5e9; }
  html,body { height:100%; }
  body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--ink); }
  .wrap { max-width:960px; margin:32px auto; padding:0 16px; }
  .card { background:var(--card); border-radius:16px; padding:24px; box-shadow:0 10px 30px rgba(2,6,23,.08); }
  h1 { font-size:1.3rem; margin:0 0 10px; }
  p  { color:var(--sub); margin:0 0 14px; }
  .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
  input[type=file] { padding:10px; border:1px solid #cbd5e1; border-radius:12px; background:#f1f5f9; }
  button { padding:10px 16px; border:0; border-radius:12px; cursor:pointer; background:var(--brand); color:#fff; font-weight:600; }
  button.secondary{ background:#0f766e; }
  button[disabled]{ opacity:.5; cursor:not-allowed; }
  .badge{ display:inline-block; padding:4px 8px; border-radius:999px; background:var(--chip); color:var(--sub); font-size:.8rem; }
  .muted{ color:var(--sub); font-size:.9rem; }
  .log { margin-top:12px; font-family:ui-monospace,Menlo,Consolas,monospace; background:#0b1020; color:#cbd5e1; padding:12px; border-radius:12px; white-space:pre-wrap; font-size:.85rem; display:none; }
  table { border-collapse:collapse; width:100%; margin-top:10px; }
  th,td{ border:1px solid #e5e7eb; padding:6px 8px; font-size:.9rem; }
  th{ background:#f1f5f9; text-align:left; }
  .divider{ height:1px; background:#e5e7eb; margin:14px 0; }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Inventory Date Updater — Preview, then Download</h1>
    <p>Sets these columns (if present, across all sheets) to today’s local date in <b>YYYYMMDD</b>: 
      <span class="badge">INVENTORY REFERENCE #</span>, 
      <span class="badge">AVAILABLE TO SHIP DATE</span>, 
      <span class="badge">REPORTING LOCATION NUMBER</span>.
    </p>

    <div class="row" style="margin-top:8px">
      <input id="file" type="file" accept=".xlsx" />
      <button id="preview" disabled>Preview updates</button>
      <span id="status" class="badge">Waiting for file</span>
    </div>

    <div id="summary" class="muted" style="margin-top:10px;"></div>
    <div id="previewArea" style="margin-top:12px; display:none;"></div>

    <div class="row" style="margin-top:10px">
      <button id="download" class="secondary" disabled>Download Updated .xlsx</button>
      <span id="outname" class="badge" title="Proposed download name" style="display:none;"></span>
    </div>

    <div id="log" class="log"></div>
  </div>
</div>

<script>
(function(){
  // ---------- Headers to update (case-insensitive) ----------
  const TARGET_HEADERS = {
    "inventory reference #": ["inventory reference #","inventory ref #","inventory reference number"],
    "available to ship date": ["available to ship date","avail to ship date","ship available date"],
    "reporting location number": ["reporting location number","reporting location #","reporting location"]
  };

  // ---------- Helpers ----------
  const byId = x => document.getElementById(x);
  const fileInput  = byId('file');
  const previewBtn = byId('preview');
  const downloadBtn= byId('download');
  const statusEl   = byId('status');
  const summaryEl  = byId('summary');
  const previewArea= byId('previewArea');
  const outnameEl  = byId('outname');
  const logEl      = byId('log');

  const pad = n => String(n).padStart(2,'0');

  // value written into cells (no dots; as requested earlier)
  function cellDateYYYYMMDD(){
    const d = new Date();
    return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}`;
  }
  // filename parts: YYYY.MM.DD and HH.mm (24h)
  function dateDots(){
    const d = new Date();
    return `${d.getFullYear()}.${pad(d.getMonth()+1)}.${pad(d.getDate())}`;
  }
  function time24h(){
    const d = new Date();
    return `${pad(d.getHours())}.${pad(d.getMinutes())}`;
  }

  function normalize(s){ return String(s||"").trim().toLowerCase().replace(/\s+/g," "); }
  function findHeaderIndexes(headerRow){
    const map = {};
    const NR = headerRow.map(h => normalize(h));
    for (const canonical in TARGET_HEADERS){
      const vars = TARGET_HEADERS[canonical].map(normalize);
      let found = -1;
      for (const v of vars){
        const i = NR.indexOf(v);
        if (i !== -1){ found = i; break; }
      }
      if (found !== -1) map[canonical] = found;
    }
    return map;
  }
  function log(msg){
    logEl.style.display = "block";
    logEl.textContent += msg + "\n";
  }

  // ---------- State ----------
  let arrayBuffer = null;
  let baseName = null;        // filename without .xlsx
  let wbModified = null;      // workbook with updates applied
  let proposedName = null;    // final file name

  // ---------- File load ----------
  fileInput.addEventListener('change', async (e) => {
    const f = e.target.files?.[0];
    if(!f){ previewBtn.disabled = true; downloadBtn.disabled = true; statusEl.textContent = "Waiting for file"; return; }
    arrayBuffer = await f.arrayBuffer();
    baseName = f.name.replace(/\.xlsx$/i,'') || "updated";
    statusEl.textContent = `Loaded: ${f.name}`;
    summaryEl.textContent = "";
    previewArea.style.display = "none";
    outnameEl.style.display = "none";
    wbModified = null;
    previewBtn.disabled = false;
    downloadBtn.disabled = true;
    logEl.textContent = "";
  });

  // ---------- Preview (apply updates in-memory, show sample) ----------
  previewBtn.addEventListener('click', () => {
    if(!arrayBuffer) return;

    // build proposed name with dotted date + 24h time
    proposedName = `${baseName} ${dateDots()} ${time24h()}.xlsx`;
    outnameEl.textContent = proposedName;
    outnameEl.style.display = "inline-block";

    statusEl.textContent = "Processing…";
    const wb = XLSX.read(arrayBuffer, { type: "array" });

    let sheetsTouched = 0, rowsUpdated = 0, colsHit = new Set();
    const stamp = cellDateYYYYMMDD();

    wb.SheetNames.forEach(sheetName => {
      const ws  = wb.Sheets[sheetName];
      const AOA = XLSX.utils.sheet_to_json(ws, { header:1, defval:"" });
      if(!AOA.length) return;

      const headers = AOA[0];
      const idxMap  = findHeaderIndexes(headers);
      const targetCols = Object.values(idxMap);
      if(!targetCols.length) return;

      for (let key in idxMap){ colsHit.add(key); }

      for (let r=1; r<AOA.length; r++){
        for (const c of targetCols){ AOA[r][c] = stamp; }
        rowsUpdated++;
      }

      // rebuild + force strings for edited cells
      const newWS = XLSX.utils.aoa_to_sheet(AOA);
      for (let r=1; r<AOA.length; r++){
        for (const c of targetCols){
          const addr = XLSX.utils.encode_cell({r, c});
          if(newWS[addr]) newWS[addr].t = 's';
        }
      }
      wb.Sheets[sheetName] = newWS;
      sheetsTouched++;
    });

    wbModified = wb;
    statusEl.textContent = "Preview ready";
    summaryEl.innerHTML = `Updated <b>${rowsUpdated.toLocaleString()}</b> data row(s) across <b>${sheetsTouched}</b> sheet(s).
      Columns hit: <span class="badge">${[...colsHit].join(", ") || "none found"}</span><br>
      Proposed name: <span class="badge">${proposedName}</span>`;

    // Build preview table from first sheet (first 12 rows)
    const firstSheet = wb.SheetNames[0];
    const ws0 = wb.Sheets[firstSheet];
    const A0 = XLSX.utils.sheet_to_json(ws0, { header:1, defval:"" });
    const maxRows = Math.min(A0.length, 13); // header + 12 rows

    let html = `<div class="divider"></div>
      <div class="muted">Preview: <b>${firstSheet}</b> — showing first ${Math.max(0,maxRows-1)} row(s)</div>`;

    if (A0.length){
      const head = A0[0];
      html += `<table><thead><tr>${
        head.map(h => `<th>${String(h||"")}</th>`).join("")
      }</tr></thead><tbody>${
        A0.slice(1, maxRows).map(row => 
          `<tr>${head.map((_,i)=>`<td>${String((row||[])[i]??"")}</td>`).join("")}</tr>`
        ).join("")
      }</tbody></table>`;
    } else {
      html += `<div class="muted">Sheet is empty.</div>`;
    }

    previewArea.innerHTML = html;
    previewArea.style.display = "block";
    downloadBtn.disabled = false;
  });

  // ---------- Download ----------
  downloadBtn.addEventListener('click', () => {
    if(!wbModified){ alert("Please click Preview first."); return; }
    // re-evaluate name at click time, so time stays current if they waited
    proposedName = `${baseName} ${dateDots()} ${time24h()}.xlsx`;
    XLSX.writeFile(wbModified, proposedName);
  });
})();
</script>
</body>
</html>
